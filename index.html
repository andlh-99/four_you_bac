<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 YOU BAC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global variables for Firebase access in our script
        window.firebaseApp = initializeApp(JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'));
        window.firebaseAuth = getAuth(window.firebaseApp);
        window.firebaseDb = getFirestore(window.firebaseApp);
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    </script>

    <style>
        /* Custom styles for animations and font */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900&display=swap');

        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl; /* Right-to-left for Arabic */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll */
            height: 100vh;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: linear-gradient(to bottom right, #0a0a2a, #1a1a4a); /* Dark blue to indigo */
            color: white;
            overflow: hidden;
        }

        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }

        .animate-spin-fast {
            animation: spin 1.5s linear infinite reverse;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-bubble {
            animation: bubble 10s infinite ease-in-out;
        }

        @keyframes bubble {
            0% { transform: translateY(0) scale(0); opacity: 0; }
            20% { opacity: 0.2; }
            40% { transform: translateY(-50vh) scale(1); opacity: 0.5; }
            60% { opacity: 0.3; }
            80% { transform: translateY(-100vh) scale(0.5); opacity: 0; }
            100% { transform: translateY(0) scale(0); opacity: 0; }
        }

        .animate-pulse-score {
            animation: pulse-score 1.5s infinite alternate;
        }
        @keyframes pulse-score {
            from { text-shadow: 0 0 5px rgba(255, 255, 0, 0.5); }
            to { text-shadow: 0 0 15px rgba(255, 255, 0, 1); }
        }

        .animate-pulse-light {
            animation: pulse-light 2s infinite ease-in-out;
        }
        @keyframes pulse-light {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .animate-scale-in {
            animation: scaleIn 0.5s ease-out forwards;
        }
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .animate-pulse-border {
            animation: pulse-border 1.5s infinite cubic-bezier(0.66, 0, 0.34, 1);
            box-shadow: 0 0 0 0 rgba(66, 153, 225, 0.7);
        }
        @keyframes pulse-border {
            to {
                box-shadow: 0 0 0 15px rgba(66, 153, 225, 0);
            }
        }

        .animate-bounce-text {
            animation: bounce-text 1s infinite alternate;
        }
        @keyframes bounce-text {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .animate-pulse-glow {
            animation: pulse-glow 1.5s infinite alternate;
        }
        @keyframes pulse-glow {
            from { box-shadow: 0 0 5px rgba(74, 222, 128, 0.7); }
            to { box-shadow: 0 0 15px rgba(74, 222, 128, 1); }
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 50;
        }
        .modal-content {
            background: linear-gradient(to bottom right, #1d4ed8, #1e3a8a); /* from-blue-700 to-blue-900 */
            padding: 1.5rem;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* shadow-2xl */
            border: 2px solid #60a5fa; /* border-blue-400 */
            color: white;
            position: relative;
            width: 100%;
            max-width: 28rem; /* max-w-md */
            animation: fadeInUp 0.6s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="app-container" class="relative flex flex-col min-h-screen bg-gradient-to-br from-blue-900 to-indigo-950 text-white overflow-hidden font-cairo">
        <div class="absolute inset-0 z-0 opacity-20">
            </div>

        <div id="loading-screen" class="relative z-10 flex flex-col items-center justify-center min-h-screen p-6 text-center">
            </div>

        <main id="main-content" class="relative z-10 flex-1 p-4 pb-20 overflow-y-auto hidden">
            </main>

        <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 z-20 bg-gradient-to-t from-blue-950 to-blue-900 border-t-2 border-blue-700 shadow-lg p-3 flex justify-around items-center rounded-t-3xl hidden">
            <button id="nav-counter" class="flex flex-col items-center p-2 rounded-xl transition-all duration-300 text-blue-500 hover:text-blue-300">
                </button>
            <button id="nav-home" class="flex flex-col items-center p-2 rounded-xl transition-all duration-300 text-blue-300 bg-blue-800 shadow-inner">
                </button>
            <button id="nav-baccalaureates" class="flex flex-col items-center p-2 rounded-xl transition-all duration-300 text-blue-500 hover:text-blue-300">
                </button>
        </nav>

        <div id="custom-modal-container"></div>
        <div id="ranking-modal-container"></div>
    </div>

    <script>
        // Global state variables
        let appState = {
            loading: true,
            onboardingStep: 0,
            currentPage: 'home', // 'home', 'counter', 'baccalaureates'
            showModal: false,
            modalContent: '',
            showRankingModal: false,
            currentRankingType: '',
            user: null,
            userId: null,
            db: null,
            auth: null,
            isAuthReady: false,
            userScore: 0,
            generalRanking: [],
            weeklyRanking: [],
            timerRunning: false,
            timeElapsed: 0, // in seconds
            sessionScore: 0,
            timerInterval: null,
            lastActiveTime: Date.now(),
            selectedSubjects: [],
            showSubjectSelection: true,
            showEditSubjects: false,
            selectedBacSubject: null,
            selectedStream: null,
            solvedYears: {}, // {subject: {stream: [year, year]}}
            completionPercentages: {}, // {subject: percentage}
        };

        const subjectsData = [
            { name: 'الرياضيات', streams: ['جميع الشعب'] },
            { name: 'الفيزياء', streams: ['جميع الشعب'] },
            { name: 'اللغة العربية', streams: ['جميع الشعب'] },
            { name: 'الفرنسية', streams: ['جميع الشعب'] },
            { name: 'الإنجليزية', streams: ['جميع الشعب'] },
            { name: 'الاجتماعيات', streams: ['جميع الشعب'] },
            { name: 'الشريعة', streams: ['جميع الشعب'] },
            { name: 'العلوم الطبيعية والحياة', streams: ['شعبة العلوم التجريبية', 'شعبة الرياضيات'] },
        ];

        const yearsData = Array.from({ length: 18 }, (_, i) => 2008 + i); // Years from 2008 to 2025

        // Mock Telegram WebApp data for development
        const mockTelegramUser = {
            id: '123456789',
            first_name: 'طالب',
            last_name: 'مثالي',
            username: 'student_example',
            language_code: 'ar',
            photo_url: 'https://placehold.co/100x100/3498db/ffffff?text=صورة'
        };

        const onboardingContent = [
            {
                title: "مرحباً بك في 4 YOU BAC!",
                description: "تطبيقك الأمثل للتحضير للبكالوريا. هنا، ستجد كل ما تحتاجه لتحقيق النجاح والتفوق في دراستك. دعنا نأخذك في جولة سريعة لاكتشاف ميزاتنا الفريدة التي صُممت خصيصًا لمساعدتك على تحقيق أهدافك الأكاديمية."
            },
            {
                title: "حساب ترتيبك وتحفيزك",
                description: "نحن نؤمن بأن المنافسة الإيجابية هي مفتاح التميز. سيقوم التطبيق بحساب ترتيبك بناءً على أدائك في حل البكالوريات والوقت الذي تقضيه في الدراسة. هذا الترتيب سيحفزك لتقديم الأفضل دائمًا، وستتمكن من رؤية مكانك بين زملائك، مما يدفعك نحو المزيد من التقدم والاجتهاد. استعد لتكون ضمن الأوائل!"
            },
            {
                title: "ميزات جديدة قريبًا",
                description: "فريق 4 YOU BAC يعمل باستمرار على تطوير التطبيق وإضافة ميزات مبتكرة ستغير تجربتك الدراسية. ترقبوا قريبًا أدوات تفاعلية، موارد تعليمية إضافية، وميزات مجتمعية ستجعل رحلتك نحو البكالوريا أكثر سهولة ومتعة. نحن ملتزمون بتقديم الأفضل لكم دائمًا!"
            },
            {
                title: "الشفافية وتحذير من الغش",
                description: "في 4 YOU BAC، نؤمن بالنزاهة والشفافية التامة. تم تصميم التطبيق ليعزز التعلم الحقيقي والجهد الشخصي. لن تجد أي ثغرات للغش أو طرق مختصرة هنا. هدفنا هو بناء جيل من الطلاب المتميزين الذين يعتمدون على قدراتهم وجهدهم الخاص. كن واثقًا بأن ترتيبك يعكس مجهودك الحقيقي."
            },
            {
                title: "المجموعة 4YOU BAC",
                description: "هذا التطبيق هو جزء من رؤية مجموعة '4YOU BAC' الطموحة، وهو ثمرة جهد وتفانٍ من فريق عمل 'Askeladd'. نحن هنا لدعمك في كل خطوة على طريق النجاح، ونفخر بتقديم هذا المورد التعليمي المتميز الذي يهدف إلى تمكينك من تحقيق أقصى إمكاناتك في امتحان البكالوريا."
            }
        ];

        // --- Utility Functions ---
        function getIconSVG(name, size = 24, className = '') {
            const icons = {
                Home: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className} lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
                Timer: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className} lucide lucide-timer"><path d="M10 2h4"/><path d="M12 14v4"/><path d="M4.93 4.93l1.41 1.41"/><path d="M19.07 4.93l-1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M17.66 17.66l1.41 1.41"/><path d="M6.34 17.66l-1.41 1.41"/><circle cx="12" cy="12" r="10"/></svg>`,
                BookOpen: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className} lucide lucide-book-open"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`,
                X: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className} lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
                ChevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className} lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>`,
                ChevronLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className} lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>`,
                Award: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className} lucide lucide-award"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17.18 21l-5.15-3.62L6.82 21l1.703-8.11"/></svg>`,
                Trophy: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className} lucide lucide-trophy"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4.2 9a6 6 0 0 0 11.6 2.02V21H2V9.02C2.7 9 3.4 9 4.2 9Z"/><path d="M10.5 11.98a6 6 0 0 1 3 0"/><path d="M12 17v4"/><path d="M15.5 17h-7"/></svg>`,
                User: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className} lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
                CheckCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className} lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>`,
                Edit: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className} lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>`,
                List: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className} lucide lucide-list"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>`
            };
            return icons[name] || '';
        }

        function showCustomModal(message) {
            appState.showModal = true;
            appState.modalContent = message;
            renderCustomModal();
        }

        function hideCustomModal() {
            appState.showModal = false;
            appState.modalContent = '';
            renderCustomModal();
        }

        function renderCustomModal() {
            const modalContainer = document.getElementById('custom-modal-container');
            if (appState.showModal) {
                modalContainer.innerHTML = `
                    <div class="modal-overlay font-cairo">
                        <div class="modal-content text-center">
                            <h3 class="text-xl font-bold mb-4 text-blue-100">تنبيه</h3>
                            <p class="mb-6 text-blue-200">${appState.modalContent}</p>
                            <button id="modal-close-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">
                                حسناً
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('modal-close-btn').addEventListener('click', hideCustomModal);
            } else {
                modalContainer.innerHTML = '';
            }
        }

        function showRankingModal(type) {
            appState.showRankingModal = true;
            appState.currentRankingType = type;
            renderRankingModal();
        }

        function hideRankingModal() {
            appState.showRankingModal = false;
            appState.currentRankingType = '';
            renderRankingModal();
        }

        function renderRankingModal() {
            const rankingModalContainer = document.getElementById('ranking-modal-container');
            if (appState.showRankingModal) {
                const rankingData = appState.currentRankingType === 'general' ? appState.generalRanking : appState.weeklyRanking;
                const sortedRanking = [...rankingData].sort((a, b) => b.score - a.score);
                const topThree = sortedRanking.slice(0, 3);
                const restOfRanking = sortedRanking.slice(3, 10);

                const userInTopTen = sortedRanking.some(entry => entry.id === appState.userId);
                const currentUserEntry = sortedRanking.find(entry => entry.id === appState.userId);
                const currentUserIndex = currentUserEntry ? sortedRanking.indexOf(currentUserEntry) + 1 : -1;

                rankingModalContainer.innerHTML = `
                    <div class="modal-overlay font-cairo">
                        <div class="modal-content w-full max-w-md text-white border-2 border-blue-400 relative">
                            <button id="ranking-close-btn" class="absolute top-3 right-3 text-blue-200 hover:text-white transition-colors duration-300">
                                ${getIconSVG('X', 24)}
                            </button>
                            <h2 class="text-3xl font-extrabold text-center mb-6 text-blue-100 drop-shadow-lg">
                                ${appState.currentRankingType === 'general' ? 'الترتيب العام' : 'الترتيب الأسبوعي'}
                            </h2>

                            ${topThree.length > 0 ? `
                                <div class="flex justify-around items-end mb-8 relative">
                                    ${topThree[1] ? `
                                        <div class="flex flex-col items-center -mb-4 z-10">
                                            <img src="${topThree[1].photo_url || 'https://placehold.co/80x80/3498db/ffffff?text=2'}" alt="Second Place" class="w-20 h-20 rounded-full border-4 border-gray-300 shadow-lg mb-2 transform hover:scale-110 transition-transform duration-300" />
                                            <span class="text-lg font-bold text-gray-200">${topThree[1].name || 'مجهول'}</span>
                                            <span class="text-sm text-gray-300">${topThree[1].score} نقطة</span>
                                            ${getIconSVG('Award', 36, 'text-gray-300 mt-1')}
                                        </div>
                                    ` : ''}
                                    ${topThree[0] ? `
                                        <div class="flex flex-col items-center z-20">
                                            <img src="${topThree[0].photo_url || 'https://placehold.co/100x100/FFD700/ffffff?text=1'}" alt="First Place" class="w-28 h-28 rounded-full border-4 border-yellow-400 shadow-xl mb-3 transform hover:scale-110 transition-transform duration-300" />
                                            <span class="text-xl font-extrabold text-yellow-300">${topThree[0].name || 'مجهول'}</span>
                                            <span class="text-base text-yellow-400">${topThree[0].score} نقطة</span>
                                            ${getIconSVG('Trophy', 48, 'text-yellow-400 mt-2')}
                                        </div>
                                    ` : ''}
                                    ${topThree[2] ? `
                                        <div class="flex flex-col items-center -mb-4 z-10">
                                            <img src="${topThree[2].photo_url || 'https://placehold.co/80x80/CD7F32/ffffff?text=3'}" alt="Third Place" class="w-20 h-20 rounded-full border-4 border-orange-400 shadow-lg mb-2 transform hover:scale-110 transition-transform duration-300" />
                                            <span class="text-lg font-bold text-orange-300">${topThree[2].name || 'مجهول'}</span>
                                            <span class="text-sm text-orange-400">${topThree[2].score} نقطة</span>
                                            ${getIconSVG('Award', 36, 'text-orange-400 mt-1')}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}

                            <div class="space-y-3 mb-6">
                                ${restOfRanking.map((entry, index) => `
                                    <div class="flex items-center bg-blue-800 p-3 rounded-lg shadow-inner border border-blue-600">
                                        <span class="font-bold text-blue-200 w-8 text-center">${index + 4}.</span>
                                        <img src="${entry.photo_url || 'https://placehold.co/40x40/3498db/ffffff?text=صورة'}" alt="User" class="w-10 h-10 rounded-full border-2 border-blue-400 ml-3" />
                                        <span class="flex-1 text-blue-100 font-medium">${entry.name || 'مجهول'}</span>
                                        <span class="text-blue-300 text-sm">${entry.score} نقطة</span>
                                    </div>
                                `).join('')}
                            </div>

                            ${!userInTopTen && currentUserIndex !== -1 ? `
                                <div class="mt-6 p-4 bg-blue-800 rounded-lg shadow-lg border border-blue-600 text-center">
                                    <h3 class="text-xl font-bold text-blue-100 mb-2">ترتيبك الحالي:</h3>
                                    <div class="flex items-center justify-center">
                                        <span class="text-2xl font-extrabold text-blue-300 ml-2">${currentUserIndex}.</span>
                                        <img src="${currentUserEntry?.photo_url || 'https://placehold.co/50x50/3498db/ffffff?text=أنت'}" alt="Your Photo" class="w-12 h-12 rounded-full border-2 border-blue-400 mr-2" />
                                        <span class="text-xl font-bold text-blue-200">${currentUserEntry?.name || 'أنت'}</span>
                                        <span class="text-lg text-blue-300 mr-2">(${currentUserEntry?.score} نقطة)</span>
                                    </div>
                                </div>
                            ` : ''}
                            ${appState.userId ? `
                                <div class="mt-4 text-center text-blue-400 text-xs">
                                    معرف المستخدم: ${appState.userId}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                document.getElementById('ranking-close-btn').addEventListener('click', hideRankingModal);
            } else {
                rankingModalContainer.innerHTML = '';
            }
        }

        // --- Render Functions for different screens/pages ---
        function renderBubbles() {
            const backgroundDiv = document.querySelector('.absolute.inset-0.z-0.opacity-20');
            backgroundDiv.innerHTML = ''; // Clear existing bubbles
            for (let i = 0; i < 20; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'absolute bg-blue-400 rounded-full animate-bubble';
                bubble.style.width = `${Math.random() * 50 + 20}px`;
                bubble.style.height = `${Math.random() * 50 + 20}px`;
                bubble.style.left = `${Math.random() * 100}%`;
                bubble.style.top = `${Math.random() * 100}%`;
                bubble.style.animationDuration = `${Math.random() * 10 + 5}s`;
                bubble.style.animationDelay = `${Math.random() * 5}s`;
                bubble.style.opacity = Math.random() * 0.5 + 0.1;
                backgroundDiv.appendChild(bubble);
            }
        }

        function renderLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            const mainContent = document.getElementById('main-content');
            const bottomNav = document.getElementById('bottom-nav');

            if (appState.loading) {
                loadingScreen.classList.remove('hidden');
                mainContent.classList.add('hidden');
                bottomNav.classList.add('hidden');

                if (appState.onboardingStep === 0) {
                    loadingScreen.innerHTML = `
                        <div class="relative z-10 flex flex-col items-center justify-center p-6 text-center">
                            <div class="relative w-32 h-32 mb-8">
                                <div class="absolute inset-0 border-4 border-blue-400 border-t-transparent rounded-full animate-spin-slow"></div>
                                <div class="absolute inset-2 border-4 border-blue-300 border-b-transparent rounded-full animate-spin-fast"></div>
                                <img src="https://placehold.co/80x80/3498db/ffffff?text=4YOU" alt="4YOU BAC Logo" class="absolute inset-0 m-auto w-24 h-24 object-contain rounded-full" />
                            </div>
                            <h1 class="text-5xl font-extrabold mb-4 text-blue-100 drop-shadow-lg">4 YOU BAC</h1>
                            <p class="text-xl text-blue-200 mb-8 max-w-sm">
                                تطبيقك الأمثل للتحضير للبكالوريا
                            </p>
                        </div>
                    `;
                    // Automatically advance to onboarding after a short delay
                    setTimeout(() => {
                        appState.onboardingStep = 1;
                        renderLoadingScreen();
                    }, 2000);
                } else {
                    const currentOnboarding = onboardingContent[appState.onboardingStep - 1];
                    loadingScreen.innerHTML = `
                        <div class="relative z-10 p-6 max-w-md w-full bg-gradient-to-br from-blue-800 to-blue-900 rounded-2xl shadow-xl border border-blue-600 text-center animate-fade-in-up">
                            <h2 class="text-3xl font-extrabold mb-4 text-blue-100 drop-shadow-md">
                                ${currentOnboarding.title}
                            </h2>
                            <p class="text-lg text-blue-200 mb-8 leading-relaxed">
                                ${currentOnboarding.description}
                            </p>
                            <div class="flex justify-between items-center mt-6">
                                ${appState.onboardingStep < onboardingContent.length ? `
                                    <button id="onboarding-next-btn" class="flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">
                                        التالي ${getIconSVG('ChevronRight', 20, 'mr-2')}
                                    </button>
                                ` : `
                                    <button id="onboarding-close-btn" class="flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75">
                                        إغلاق ${getIconSVG('X', 20, 'mr-2')}
                                    </button>
                                `}
                                <button id="onboarding-skip-btn" class="text-blue-300 hover:text-blue-100 transition-colors duration-300 text-sm font-medium">
                                    تخطي الشرح
                                </button>
                            </div>
                            <div class="flex justify-center mt-4 space-x-2 rtl:space-x-reverse">
                                ${onboardingContent.map((_, index) => `
                                    <span class="block w-3 h-3 rounded-full ${appState.onboardingStep - 1 === index ? 'bg-blue-400' : 'bg-blue-700'} transition-colors duration-300"></span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    document.getElementById('onboarding-skip-btn').addEventListener('click', handleSkipOnboarding);
                    if (appState.onboardingStep < onboardingContent.length) {
                        document.getElementById('onboarding-next-btn').addEventListener('click', handleNextOnboarding);
                    } else {
                        document.getElementById('onboarding-close-btn').addEventListener('click', handleSkipOnboarding);
                    }
                }
            } else {
                loadingScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                renderMainContent();
                renderBottomNav();
            }
        }

        function renderMainContent() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = ''; // Clear previous content

            if (appState.currentPage === 'home') {
                renderHomePage(mainContent);
            } else if (appState.currentPage === 'counter') {
                renderCounterPage(mainContent);
            } else if (appState.currentPage === 'baccalaureates') {
                renderBaccalaureatesPage(mainContent);
            }
        }

        function renderHomePage(container) {
            container.innerHTML = `
                <div class="animate-fade-in-up">
                    <div class="flex items-center justify-center mb-8 bg-blue-800 p-4 rounded-xl shadow-lg border border-blue-600">
                        <img src="${appState.user?.photo_url || 'https://placehold.co/100x100/3498db/ffffff?text=أنت'}" alt="User Profile" class="w-24 h-24 rounded-full border-4 border-blue-400 shadow-md ml-4" />
                        <div class="text-right">
                            <h2 class="text-3xl font-extrabold text-blue-100 drop-shadow-md">مرحباً، ${appState.user?.first_name || 'مستخدم'}!</h2>
                            <p class="text-blue-300 text-sm">معرف المستخدم: ${appState.userId}</p>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-blue-700 to-blue-900 p-6 rounded-2xl shadow-xl border border-blue-600 text-center mb-8">
                        <h3 class="text-2xl font-bold text-blue-100 mb-2">سكورك الحالي</h3>
                        <p id="user-score-display" class="text-6xl font-extrabold text-yellow-400 drop-shadow-lg animate-pulse-score">${appState.userScore}</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button id="general-ranking-btn" class="bg-blue-800 hover:bg-blue-700 p-6 rounded-2xl shadow-lg border border-blue-600 flex flex-col items-center justify-center transition-all duration-300 transform hover:scale-105 active:scale-95">
                            ${getIconSVG('Award', 48, 'text-blue-300 mb-3')}
                            <h3 class="text-2xl font-bold text-blue-100 mb-2">الترتيب العام</h3>
                            <p class="text-blue-200">شاهد ترتيبك بين جميع المستخدمين</p>
                        </button>
                        <button id="weekly-ranking-btn" class="bg-blue-800 hover:bg-blue-700 p-6 rounded-2xl shadow-lg border border-blue-600 flex flex-col items-center justify-center transition-all duration-300 transform hover:scale-105 active:scale-95">
                            ${getIconSVG('Trophy', 48, 'text-blue-300 mb-3')}
                            <h3 class="text-2xl font-bold text-blue-100 mb-2">الترتيب الأسبوعي</h3>
                            <p class="text-blue-200">تتبع تقدمك الأسبوعي</p>
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('general-ranking-btn').addEventListener('click', () => showRankingModal('general'));
            document.getElementById('weekly-ranking-btn').addEventListener('click', () => showRankingModal('weekly'));
        }

        function renderCounterPage(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[calc(100vh-120px)] animate-fade-in-up">
                    <div class="relative w-full max-w-xs aspect-square mb-8">
                        <img
                            src="https://placehold.co/400x400/2C3E50/ECF0F1?text=طالب+يدرس"
                            alt="Studying Person"
                            class="w-full h-full object-cover rounded-full shadow-2xl border-4 border-blue-400 animate-pulse-light"
                        />
                    </div>

                    <div class="relative w-64 h-64 flex items-center justify-center mb-8 bg-gradient-to-br from-blue-700 to-blue-900 rounded-full shadow-xl border-4 border-blue-500 animate-scale-in">
                        <div class="absolute inset-0 rounded-full animate-pulse-border"></div>
                        <div class="text-center">
                            <p id="timer-display" class="text-6xl font-extrabold text-green-400 drop-shadow-lg mb-2 animate-bounce-text">
                                ${new Date(appState.timeElapsed * 1000).toISOString().substr(11, 8)}
                            </p>
                            <p class="text-2xl font-bold text-blue-200">السكور: <span id="session-score-display" class="text-yellow-300">${appState.sessionScore}</span></p>
                        </div>
                    </div>

                    <button id="timer-toggle-btn" class="w-full max-w-xs py-4 px-6 rounded-full font-extrabold text-2xl shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95
                        ${appState.timerRunning ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}
                        focus:outline-none focus:ring-2 ${appState.timerRunning ? 'focus:ring-red-400' : 'focus:ring-green-400'} focus:ring-opacity-75">
                        ${appState.timerRunning ? 'إيقاف' : 'بداية'}
                    </button>
                </div>
            `;
            document.getElementById('timer-toggle-btn').addEventListener('click', () => {
                if (appState.timerRunning) {
                    stopTimer();
                } else {
                    startTimer();
                }
            });
        }

        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timer-display');
            const sessionScoreDisplay = document.getElementById('session-score-display');
            const timerToggleButton = document.getElementById('timer-toggle-btn');

            if (timerDisplay) {
                timerDisplay.textContent = new Date(appState.timeElapsed * 1000).toISOString().substr(11, 8);
            }
            if (sessionScoreDisplay) {
                sessionScoreDisplay.textContent = appState.sessionScore;
            }
            if (timerToggleButton) {
                timerToggleButton.textContent = appState.timerRunning ? 'إيقاف' : 'بداية';
                timerToggleButton.className = `w-full max-w-xs py-4 px-6 rounded-full font-extrabold text-2xl shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95
                    ${appState.timerRunning ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}
                    focus:outline-none focus:ring-2 ${appState.timerRunning ? 'focus:ring-red-400' : 'focus:ring-green-400'} focus:ring-opacity-75`;
            }
        }

        function renderBaccalaureatesPage(container) {
            container.innerHTML = `
                <div class="animate-fade-in-up">
                    <h2 class="text-3xl font-extrabold text-blue-100 text-center mb-8 drop-shadow-md">صفحة البكالوريات</h2>

                    <div id="subject-selection-section" class="${appState.showSubjectSelection ? '' : 'hidden'} bg-gradient-to-br from-blue-700 to-blue-900 p-6 rounded-2xl shadow-xl border border-blue-600 mb-8">
                        <h3 class="text-2xl font-bold text-blue-100 mb-6 text-center">اختر المواد الدراسية</h3>
                        <div id="subject-buttons-container" class="grid grid-cols-2 gap-4 mb-6">
                            </div>
                        <button id="continue-subject-selection-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75">
                            متابعة
                        </button>
                    </div>

                    <div id="edit-subjects-section" class="${appState.showEditSubjects ? '' : 'hidden'} bg-gradient-to-br from-blue-700 to-blue-900 p-6 rounded-2xl shadow-xl border border-blue-600 mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-blue-100">موادك المختارة</h3>
                            <button id="edit-subjects-btn" class="flex items-center bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95">
                                ${getIconSVG('Edit', 18, 'ml-2')} تعديل
                            </button>
                        </div>
                        <div id="selected-subjects-list" class="space-y-4">
                            </div>
                    </div>

                    <div id="select-stream-section" class="${appState.selectedBacSubject && !appState.selectedStream ? '' : 'hidden'} bg-gradient-to-br from-blue-700 to-blue-900 p-6 rounded-2xl shadow-xl border border-blue-600 mb-8">
                        <h3 class="text-2xl font-bold text-blue-100 mb-6 text-center">
                            ${appState.selectedBacSubject ? appState.selectedBacSubject.name : ''} - اختر الشعبة
                        </h3>
                        <div id="stream-buttons-container" class="grid grid-cols-1 gap-4 mb-6">
                            </div>
                        <button id="back-to-subjects-from-stream-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75">
                            العودة للمواد
                        </button>
                    </div>

                    <div id="select-year-section" class="${appState.selectedBacSubject && appState.selectedStream ? '' : 'hidden'} bg-gradient-to-br from-blue-700 to-blue-900 p-6 rounded-2xl shadow-xl border border-blue-600">
                        <h3 class="text-2xl font-bold text-blue-100 mb-6 text-center">
                            ${appState.selectedBacSubject ? appState.selectedBacSubject.name : ''} - ${appState.selectedStream || ''} - سنوات البكالوريا
                        </h3>
                        <div id="year-buttons-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 mb-6">
                            </div>
                        <button id="back-to-streams-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75">
                            العودة للشعب
                        </button>
                    </div>
                </div>
            `;
            renderBaccalaureatesSubSections();
            attachBaccalaureatesListeners();
        }

        function renderBaccalaureatesSubSections() {
            const subjectSelectionSection = document.getElementById('subject-selection-section');
            const editSubjectsSection = document.getElementById('edit-subjects-section');
            const selectStreamSection = document.getElementById('select-stream-section');
            const selectYearSection = document.getElementById('select-year-section');

            subjectSelectionSection.classList.toggle('hidden', !appState.showSubjectSelection);
            editSubjectsSection.classList.toggle('hidden', !appState.showEditSubjects);
            selectStreamSection.classList.toggle('hidden', !(appState.selectedBacSubject && !appState.selectedStream));
            selectYearSection.classList.toggle('hidden', !(appState.selectedBacSubject && appState.selectedStream));

            // Render subject selection buttons
            const subjectButtonsContainer = document.getElementById('subject-buttons-container');
            if (subjectButtonsContainer) {
                subjectButtonsContainer.innerHTML = subjectsData.map(subject => `
                    <button data-subject="${subject.name}" class="py-3 px-4 rounded-lg font-bold text-lg transition-all duration-200
                        ${appState.selectedSubjects.includes(subject.name)
                            ? 'bg-blue-500 text-white shadow-lg border border-blue-400'
                            : 'bg-blue-800 text-blue-200 hover:bg-blue-700 border border-blue-700'
                        }
                        flex items-center justify-center">
                        ${appState.selectedSubjects.includes(subject.name) ? getIconSVG('CheckCircle', 20, 'ml-2 text-green-300') : ''}
                        ${subject.name}
                    </button>
                `).join('');
                subjectButtonsContainer.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', () => handleSubjectToggle(button.dataset.subject));
                });
            }

            // Render selected subjects list for editing
            const selectedSubjectsList = document.getElementById('selected-subjects-list');
            if (selectedSubjectsList) {
                selectedSubjectsList.innerHTML = appState.selectedSubjects.map(subjectName => `
                    <div class="bg-blue-800 p-4 rounded-lg shadow-inner border border-blue-600 flex items-center justify-between">
                        <span class="text-xl font-bold text-blue-100">${subjectName}</span>
                        <div class="flex items-center">
                            <div class="w-20 h-4 bg-blue-600 rounded-full overflow-hidden mr-3">
                                <div class="h-full bg-green-400 rounded-full transition-all duration-500" style="width: ${appState.completionPercentages[subjectName]?.toFixed(0) || 0}%"></div>
                            </div>
                            <span class="text-blue-200 font-bold">${appState.completionPercentages[subjectName]?.toFixed(0) || 0}%</span>
                            <button data-subject="${subjectName}" class="ml-4 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95">
                                عرض ${getIconSVG('ChevronRight', 18, 'inline ml-1')}
                            </button>
                        </div>
                    </div>
                `).join('');
                selectedSubjectsList.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', () => handleSelectBacSubject(button.dataset.subject));
                });
            }

            // Render stream buttons
            const streamButtonsContainer = document.getElementById('stream-buttons-container');
            if (streamButtonsContainer && appState.selectedBacSubject) {
                streamButtonsContainer.innerHTML = appState.selectedBacSubject.streams.map(stream => `
                    <button data-stream="${stream}" class="py-3 px-4 rounded-lg font-bold text-lg transition-all duration-200
                        ${appState.selectedStream === stream
                            ? 'bg-blue-500 text-white shadow-lg border border-blue-400'
                            : 'bg-blue-800 text-blue-200 hover:bg-blue-700 border border-blue-700'
                        }
                        flex items-center justify-center">
                        ${appState.selectedStream === stream ? getIconSVG('CheckCircle', 20, 'ml-2 text-green-300') : ''}
                        ${stream}
                    </button>
                `).join('');
                streamButtonsContainer.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', () => handleSelectStream(button.dataset.stream));
                });
            }

            // Render year buttons
            const yearButtonsContainer = document.getElementById('year-buttons-container');
            if (yearButtonsContainer && appState.selectedBacSubject && appState.selectedStream) {
                yearButtonsContainer.innerHTML = yearsData.map(year => `
                    <button data-year="${year}" class="py-3 px-2 rounded-lg font-bold text-lg transition-all duration-200
                        ${isYearSolved(appState.selectedBacSubject.name, appState.selectedStream, year)
                            ? 'bg-green-500 text-white shadow-lg border border-green-400 animate-pulse-glow'
                            : 'bg-blue-800 text-blue-200 hover:bg-blue-700 border border-blue-700'
                        }
                        flex items-center justify-center">
                        ${year}
                    </button>
                `).join('');
                yearButtonsContainer.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', () => handleYearClick(parseInt(button.dataset.year)));
                });
            }
        }

        function attachBaccalaureatesListeners() {
            const continueSubjectBtn = document.getElementById('continue-subject-selection-btn');
            if (continueSubjectBtn) {
                continueSubjectBtn.onclick = handleContinueSubjectSelection;
            }

            const editSubjectsBtn = document.getElementById('edit-subjects-btn');
            if (editSubjectsBtn) {
                editSubjectsBtn.onclick = handleEditSubjects;
            }

            const backToSubjectsFromStreamBtn = document.getElementById('back-to-subjects-from-stream-btn');
            if (backToSubjectsFromStreamBtn) {
                backToSubjectsFromStreamBtn.onclick = () => {
                    appState.selectedBacSubject = null;
                    appState.selectedStream = null;
                    renderBaccalaureatesSubSections();
                };
            }

            const backToStreamsBtn = document.getElementById('back-to-streams-btn');
            if (backToStreamsBtn) {
                backToStreamsBtn.onclick = () => {
                    appState.selectedStream = null;
                    renderBaccalaureatesSubSections();
                };
            }
        }


        function renderBottomNav() {
            const navHomeBtn = document.getElementById('nav-home');
            const navCounterBtn = document.getElementById('nav-counter');
            const navBaccalaureatesBtn = document.getElementById('nav-baccalaureates');

            navHomeBtn.innerHTML = `${getIconSVG('Home', 32)}<span class="text-xs mt-1">الرئيسية</span>`;
            navCounterBtn.innerHTML = `${getIconSVG('Timer', 28)}<span class="text-xs mt-1">العداد</span>`;
            navBaccalaureatesBtn.innerHTML = `${getIconSVG('BookOpen', 28)}<span class="text-xs mt-1">البكالوريات</span>`;

            // Remove previous listeners to prevent duplicates
            navHomeBtn.replaceWith(navHomeBtn.cloneNode(true));
            navCounterBtn.replaceWith(navCounterBtn.cloneNode(true));
            navBaccalaureatesBtn.replaceWith(navBaccalaureatesBtn.cloneNode(true));

            document.getElementById('nav-home').addEventListener('click', () => setPage('home'));
            document.getElementById('nav-counter').addEventListener('click', () => setPage('counter'));
            document.getElementById('nav-baccalaureates').addEventListener('click', () => setPage('baccalaureates'));

            // Update active state
            [document.getElementById('nav-home'), document.getElementById('nav-counter'), document.getElementById('nav-baccalaureates')].forEach(btn => {
                const pageName = btn.id.replace('nav-', '');
                if (pageName === appState.currentPage) {
                    btn.classList.add('text-blue-300', 'bg-blue-800', 'shadow-inner');
                    btn.classList.remove('text-blue-500', 'hover:text-blue-300');
                } else {
                    btn.classList.remove('text-blue-300', 'bg-blue-800', 'shadow-inner');
                    btn.classList.add('text-blue-500', 'hover:text-blue-300');
                }
            });
        }

        // --- State Management and Event Handlers ---
        function setPage(pageName) {
            appState.currentPage = pageName;
            renderMainContent();
            renderBottomNav();
        }

        function handleNextOnboarding() {
            if (appState.onboardingStep < onboardingContent.length) { // Corrected condition
                appState.onboardingStep++;
                renderLoadingScreen();
            } else {
                handleSkipOnboarding();
            }
        }

        function handleSkipOnboarding() {
            appState.loading = false;
            renderLoadingScreen(); // This will transition to main content
        }

        function startTimer() {
            if (!appState.timerRunning) {
                appState.timerRunning = true;
                appState.lastActiveTime = Date.now();
                appState.timerInterval = setInterval(() => {
                    appState.timeElapsed++;
                    appState.sessionScore++; // 1 point per second
                    updateTimerDisplay();
                }, 1000);
                updateTimerDisplay(); // Initial update
            }
        }

        function stopTimer() {
            if (appState.timerRunning) {
                appState.timerRunning = false;
                clearInterval(appState.timerInterval);
                appState.timerInterval = null;
                // Update user's total score in Firestore
                if (appState.db && appState.userId) {
                    const userDocRef = appState.db.doc(`artifacts/${appState.appId}/users/${appState.userId}/profile`, 'data');
                    appState.db.updateDoc(userDocRef, {
                        score: appState.userScore + appState.sessionScore,
                        lastActive: Date.now()
                    }).then(() => {
                        appState.userScore += appState.sessionScore;
                        appState.sessionScore = 0; // Reset session score
                        updateTimerDisplay(); // Update display after score reset
                        // No need to re-render home page, onSnapshot will handle it
                    }).catch(error => {
                        console.error("Error updating score:", error);
                        showCustomModal("حدث خطأ أثناء تحديث النتيجة.");
                    });
                }
                updateTimerDisplay(); // Final update
            }
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                stopTimer();
            }
        }

        function handleSubjectToggle(subjectName) {
            if (appState.selectedSubjects.includes(subjectName)) {
                appState.selectedSubjects = appState.selectedSubjects.filter(s => s !== subjectName);
            } else {
                appState.selectedSubjects = [...appState.selectedSubjects, subjectName];
            }
            renderBaccalaureatesSubSections();
        }

        function handleContinueSubjectSelection() {
            if (appState.selectedSubjects.length > 0) {
                appState.showSubjectSelection = false;
                appState.showEditSubjects = true;
                renderBaccalaureatesSubSections();
            } else {
                showCustomModal("الرجاء اختيار مادة واحدة على الأقل للمتابعة.");
            }
        }

        function handleEditSubjects() {
            appState.showSubjectSelection = true;
            appState.showEditSubjects = false;
            appState.selectedBacSubject = null; // Reset selection
            appState.selectedStream = null; // Reset selection
            renderBaccalaureatesSubSections();
        }

        function handleSelectBacSubject(subjectName) {
            appState.selectedBacSubject = subjectsData.find(s => s.name === subjectName);
            appState.selectedStream = null; // Reset stream when subject changes
            renderBaccalaureatesSubSections();
        }

        function handleSelectStream(streamName) {
            appState.selectedStream = streamName;
            renderBaccalaureatesSubSections();
        }

        function handleYearClick(year) {
            if (!appState.selectedBacSubject || !appState.selectedStream) return;

            const subjectName = appState.selectedBacSubject.name;
            const currentSolvedYears = { ...appState.solvedYears };

            if (!currentSolvedYears[subjectName]) {
                currentSolvedYears[subjectName] = {};
            }
            if (!currentSolvedYears[subjectName][appState.selectedStream]) {
                currentSolvedYears[subjectName][appState.selectedStream] = [];
            }

            const yearIndex = currentSolvedYears[subjectName][appState.selectedStream].indexOf(year);
            if (yearIndex > -1) {
                // Year already solved, unmark it
                currentSolvedYears[subjectName][appState.selectedStream].splice(yearIndex, 1);
            } else {
                // Mark year as solved
                currentSolvedYears[subjectName][appState.selectedStream].push(year);
            }

            appState.solvedYears = currentSolvedYears;
            calculateCompletionPercentages(); // Recalculate after change
            renderBaccalaureatesSubSections(); // Rerender to show updated year status

            // Update Firestore
            if (appState.db && appState.userId) {
                const userDocRef = appState.db.doc(`artifacts/${appState.appId}/users/${appState.userId}/profile`, 'data');
                appState.db.updateDoc(userDocRef, {
                    solvedYears: currentSolvedYears
                }).catch(error => {
                    console.error("Error updating solved years:", error);
                    showCustomModal("حدث خطأ أثناء تحديث سنوات البكالوريا المحلولة.");
                });
            }
        }

        function isYearSolved(subjectName, streamName, year) {
            return appState.solvedYears[subjectName]?.[streamName]?.includes(year);
        }

        function calculateCompletionPercentages() {
            const newCompletionPercentages = {};
            subjectsData.forEach(subject => {
                let totalPossibleYears = 0;
                let solvedYearsCount = 0;

                subject.streams.forEach(stream => {
                    totalPossibleYears += yearsData.length; // Each stream has all years
                    if (appState.solvedYears[subject.name] && appState.solvedYears[subject.name][stream]) {
                        solvedYearsCount += appState.solvedYears[subject.name][stream].length;
                    }
                });
                newCompletionPercentages[subject.name] = totalPossibleYears > 0 ? (solvedYearsCount / totalPossibleYears) * 100 : 0;
            });
            appState.completionPercentages = newCompletionPercentages;
        }

        // --- Initialization ---
        async function initializeApp() {
            try {
                appState.db = window.firebaseDb;
                appState.auth = window.firebaseAuth;
                appState.appId = window.appId;

                const unsubscribe = appState.auth.onAuthStateChanged(async (currentUser) => {
                    if (currentUser) {
                        appState.userId = currentUser.uid;
                        // Attempt to get user data from Telegram WebApp
                        const telegramUser = window.Telegram?.WebApp?.initDataUnsafe?.user || mockTelegramUser;
                        appState.user = telegramUser;
                        appState.isAuthReady = true;
                    } else {
                        // Sign in anonymously if no initial token or user
                        if (window.initialAuthToken) {
                            await appState.auth.signInWithCustomToken(window.initialAuthToken);
                        } else {
                            await appState.auth.signInAnonymously();
                        }
                    }
                    appState.loading = false;
                    renderLoadingScreen(); // Transition from loading to main content
                });

                // Fetch user data and rankings
                document.addEventListener('authReady', () => {
                    if (!appState.db || !appState.userId || !appState.isAuthReady) return;

                    const userDocRef = appState.db.doc(`artifacts/${appState.appId}/users/${appState.userId}/profile`, 'data');
                    appState.db.onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const userData = docSnap.data();
                            appState.userScore = userData.score || 0;
                            appState.solvedYears = userData.solvedYears || {};
                            calculateCompletionPercentages();
                            renderMainContent(); // Re-render to update score/progress
                        } else {
                            // Create initial user profile if it doesn't exist
                            appState.db.setDoc(userDocRef, {
                                name: appState.user?.first_name || 'مستخدم جديد',
                                score: 0,
                                solvedYears: {},
                                lastActive: Date.now(),
                                photo_url: appState.user?.photo_url || 'https://placehold.co/100x100/3498db/ffffff?text=صورة'
                            }, { merge: true });
                        }
                    }, (error) => {
                        console.error("Error fetching user data:", error);
                        showCustomModal("حدث خطأ أثناء جلب بيانات المستخدم.");
                    });

                    const generalRankingRef = appState.db.collection(`artifacts/${appState.appId}/public/data/rankings`);
                    const qGeneral = appState.db.query(generalRankingRef, appState.db.orderBy('score', 'desc'), appState.db.limit(10));
                    appState.db.onSnapshot(qGeneral, (snapshot) => {
                        appState.generalRanking = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderMainContent(); // Re-render to update rankings
                    }, (error) => {
                        console.error("Error fetching general ranking:", error);
                    });

                    const qWeekly = appState.db.query(generalRankingRef, appState.db.orderBy('score', 'desc'), appState.db.limit(10));
                    appState.db.onSnapshot(qWeekly, (snapshot) => {
                        appState.weeklyRanking = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderMainContent(); // Re-render to update rankings
                    }, (error) => {
                        console.error("Error fetching weekly ranking:", error);
                    });
                });

                // Dispatch a custom event when authentication is ready
                Object.defineProperty(appState, 'isAuthReady', {
                    set: function(value) {
                        this._isAuthReady = value;
                        if (value) {
                            document.dispatchEvent(new Event('authReady'));
                        }
                    },
                    get: function() {
                        return this._isAuthReady;
                    }
                });


            } catch (error) {
                console.error("Error initializing Firebase:", error);
                appState.loading = false;
                showCustomModal("حدث خطأ أثناء تهيئة التطبيق. يرجى المحاولة مرة أخرى.");
                renderLoadingScreen();
            }
        }

        // --- Event Listeners ---
        document.addEventListener('visibilitychange', handleVisibilityChange);

        // Initial render on window load
        window.onload = () => {
            renderBubbles();
            initializeApp();
            renderLoadingScreen(); // Start with loading screen
        };
    </script>
</body>
</html>

