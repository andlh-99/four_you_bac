<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4YOU BAC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances
        window.app;
        window.db;
        window.auth;
        window.userId; // Will store the authenticated user ID
        let isFirebaseReady = false; // Flag to indicate Firebase is fully initialized and authenticated

        // Firebase Configuration - THIS IS YOUR ACTUAL FIREBASE CONFIG
        // If running in Canvas environment, __firebase_config will be provided automatically.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyB_ONaG8ZZM-C_c0EpZbCxr6-5EEsCTC7M",
            authDomain: "bac-4you.firebaseapp.com",
            projectId: "bac-4you",
            storageBucket: "bac-4you.firebasestorage.app",
            messagingSenderId: "10492385919",
            appId: "1:10492385919:web:59570eefca36a2ab39fd4a",
            measurementId: "G-CVCZ027PDM"
        };

        // Initialize Firebase and authenticate
        window.initializeFirebase = async function() {
            console.log("بدء تهيئة Firebase...");
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.error("خطأ: إعدادات Firebase غير موجودة أو غير صحيحة. يرجى تحديث firebaseConfig بالمعلومات الفعلية لمشروعك.");
                    displayError("خطأ في تهيئة التطبيق: يرجى التحقق من إعدادات Firebase.");
                    return;
                }

                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);
                console.log("Firebase تم تهيئته بنجاح.");

                // Sign in anonymously or with custom token (from Canvas env)
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                    console.log("تم تسجيل الدخول باستخدام رمز مخصص.");
                } else {
                    await signInAnonymously(window.auth);
                    console.log("تم تسجيل الدخول كمجهول.");
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('user-id-display').textContent = window.userId;
                        console.log("معرف المستخدم:", window.userId);
                        isFirebaseReady = true; // Set flag to true
                        loadUserData();
                        loadBaccalaureateState();
                    } else {
                        window.userId = crypto.randomUUID();
                        document.getElementById('user-id-display').textContent = window.userId + " (غير موثق)";
                        console.warn("لم يتم تسجيل دخول أي مستخدم، يتم استخدام معرف عشوائي:", window.userId);
                        isFirebaseReady = true; // Still ready to operate, but data won't persist if not authenticated.
                        loadUserData();
                        loadBaccalaureateState();
                    }
                });

            } catch (error) {
                console.error("خطأ فادح أثناء تهيئة Firebase أو تسجيل الدخول:", error);
                displayError("خطأ فادح في تهيئة Firebase. يرجى التحقق من اتصالك بالإنترنت أو إعدادات المشروع.");
            }
        };

        function displayError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-center text-red-500 text-xl mt-20 p-4 bg-gray-800 rounded-lg shadow-lg max-w-md mx-auto';
            errorDiv.textContent = message;
            mainApp.innerHTML = ''; // Clear existing content
            mainApp.appendChild(errorDiv);
            mainApp.style.display = 'flex'; // Ensure main app container is visible
            onboardingOverlay.style.display = 'none'; // Hide onboarding
            splashScreen.style.display = 'none'; // Hide splash
        }

        // Firestore Data Management Functions
        window.getUserProfileDocRef = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            if (!window.db || !window.userId) {
                console.error("خطأ: Firestore أو معرف المستخدم غير جاهز لإنشاء مرجع المستند.");
                return null;
            }
            return doc(window.db, `artifacts/${appId}/users/${window.userId}/profile/data`);
        };

        window.loadUserData = async () => {
            if (!isFirebaseReady) {
                console.warn("Firebase ليس جاهزًا بعد لتحميل بيانات المستخدم.");
                // Fallback to local storage if Firebase is not ready
                userCurrentScore = parseInt(localStorage.getItem('userCurrentScore') || '0');
                userScoreElement.textContent = userCurrentScore;
                checkOnboardingStatus();
                return;
            }
            const docRef = window.getUserProfileDocRef();
            if (!docRef) {
                console.warn("مرجع مستند ملف المستخدم غير متاح.");
                checkOnboardingStatus(); // Still proceed to check onboarding
                return;
            }

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userCurrentScore = data.score || 0;
                    userScoreElement.textContent = userCurrentScore;
                    localStorage.setItem('seenOnboarding', data.seenOnboarding ? 'true' : 'false');
                    console.log("تم تحميل بيانات المستخدم من Firestore:", data);
                } else {
                    console.log("لم يتم العثور على بيانات ملف المستخدم، يتم التهيئة.");
                    userCurrentScore = 0;
                    userScoreElement.textContent = userCurrentScore;
                    localStorage.setItem('seenOnboarding', 'false');
                    window.saveUserData(); // Save initial data to Firestore
                }
                checkOnboardingStatus(); // Always check onboarding status after data is loaded/initialized
            }, (error) => {
                console.error("خطأ في الاستماع إلى بيانات المستخدم من Firestore:", error);
                // Fallback to local storage if Firestore fails
                userCurrentScore = parseInt(localStorage.getItem('userCurrentScore') || '0');
                userScoreElement.textContent = userCurrentScore;
                checkOnboardingStatus();
            });
        };

        window.saveUserData = async () => {
            if (!isFirebaseReady) {
                console.warn("Firebase ليس جاهزًا بعد لحفظ بيانات المستخدم.");
                return;
            }
            const docRef = window.getUserProfileDocRef();
            if (!docRef) return;

            try {
                await setDoc(docRef, {
                    score: userCurrentScore,
                    seenOnboarding: localStorage.getItem('seenOnboarding') === 'true'
                }, { merge: true });
                console.log("تم حفظ بيانات المستخدم بنجاح إلى Firestore.");
            } catch (error) {
                console.error("خطأ أثناء حفظ بيانات المستخدم إلى Firestore:", error);
            }
        };

        // Baccalaureate Data
        window.getBaccalaureateDocRef = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            if (!window.db || !window.userId) {
                console.error("خطأ: Firestore أو معرف المستخدم غير جاهز لإنشاء مرجع مستند البكالوريا.");
                return null;
            }
            return doc(window.db, `artifacts/${appId}/users/${window.userId}/baccalaureate/data`);
        };

        window.loadBaccalaureateState = async () => {
            if (!isFirebaseReady) {
                console.warn("Firebase ليس جاهزًا بعد لتحميل بيانات البكالوريا.");
                selectedBacSubjects = JSON.parse(localStorage.getItem('selectedBacSubjects')) || [];
                solvedBacYears = JSON.parse(localStorage.getItem('solvedBacYears')) || {};
                renderSubjectSelection();
                renderBacDetails();
                return;
            }
            const docRef = window.getBaccalaureateDocRef();
            if (!docRef) {
                console.warn("مرجع مستند البكالوريا غير متاح.");
                return;
            }

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    selectedBacSubjects = data.selectedSubjects || [];
                    solvedBacYears = data.solvedYears || {};
                    console.log("تم تحميل بيانات البكالوريا من Firestore:", data);
                } else {
                    console.log("لم يتم العثور على بيانات البكالوريا، يتم التهيئة.");
                    selectedBacSubjects = [];
                    solvedBacYears = {};
                    window.saveBaccalaureateState(); // Save initial empty state
                }
                renderSubjectSelection();
                renderBacDetails();
            }, (error) => {
                console.error("خطأ في الاستماع إلى بيانات البكالوريا من Firestore:", error);
                selectedBacSubjects = JSON.parse(localStorage.getItem('selectedBacSubjects')) || [];
                solvedBacYears = JSON.parse(localStorage.getItem('solvedBacYears')) || {};
                renderSubjectSelection();
                renderBacDetails();
            });
        };

        window.saveBaccalaureateState = async () => {
            if (!isFirebaseReady) {
                console.warn("Firebase ليس جاهزًا بعد لحفظ بيانات البكالوريا.");
                return;
            }
            const docRef = window.getBaccalaureateDocRef();
            if (!docRef) return;

            try {
                await setDoc(docRef, {
                    selectedSubjects: selectedBacSubjects,
                    solvedYears: solvedBacYears
                }, { merge: true });
                console.log("تم حفظ بيانات البكالوريا بنجاح إلى Firestore.");
            } catch (error) {
                console.error("خطأ أثناء حفظ بيانات البكالوريا إلى Firestore:", error);
            }
        };

    </script>
    <style>
        /* Cairo Font */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0A192F; /* Dark blue background */
            color: #E2E8F0; /* Light text color */
            overflow: hidden; /* Prevent body scroll, manage scroll within specific divs */
        }

        /* Custom scrollbar for content areas */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1A202C;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4A5568;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        .background-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }
        .background-animation::before,
        .background-animation::after {
            content: '';
            position: absolute;
            background: rgba(17, 25, 40, 0.5); /* Slightly lighter dark blue for effects */
            border-radius: 50%;
            animation: move-elements 20s infinite ease-in-out alternate;
        }
        .background-animation::before {
            width: 300px;
            height: 300px;
            top: -50px;
            left: -50px;
            animation-delay: 0s;
        }
        .background-animation::after {
            width: 200px;
            height: 200px;
            bottom: -50px;
            right: -50px;
            animation-delay: 5s;
        }

        @keyframes move-elements {
            0% { transform: translate(0, 0) scale(1); opacity: 0.7; }
            25% { transform: translate(50px, 100px) scale(1.1); opacity: 0.8; }
            50% { transform: translate(100px, 0) scale(1.2); opacity: 0.9; }
            75% { transform: translate(50px, -100px) scale(1.1); opacity: 0.8; }
            100% { transform: translate(0, 0) scale(1); opacity: 0.7; }
        }

        /* Splash screen styles */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0A192F, #1A202C); /* Gradient background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 1;
            transition: opacity 1s ease-out;
        }
        .splash-spinner {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid #63B3ED; /* Light blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .splash-text {
            font-size: 2.5rem;
            font-weight: 800;
            color: #63B3ED;
            text-shadow: 0 0 15px rgba(99, 179, 237, 0.5);
        }

        /* Onboarding specific styles */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease-in-out;
        }
        .onboarding-card {
            background: linear-gradient(145deg, #1A202C, #2D3748); /* Gradient for card */
            border-radius: 1.5rem; /* More rounded corners */
            padding: 2.5rem;
            max-width: 90%;
            width: 450px;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6);
            animation: slide-up 0.6s ease-out;
            border: 1px solid rgba(99, 179, 237, 0.3); /* Subtle border */
        }
        @keyframes slide-up {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .onboarding-title {
            font-size: 2.25rem; /* Larger title */
            font-weight: 700;
            color: #90CDF4; /* Lighter blue */
            margin-bottom: 1.5rem;
            text-shadow: 0 0 10px rgba(144, 205, 244, 0.3);
        }
        .onboarding-text {
            font-size: 1.15rem;
            line-height: 1.6;
            color: #CBD5E0; /* Lighter gray */
            margin-bottom: 2rem;
        }
        .onboarding-button {
            background: linear-gradient(90deg, #4299E1, #63B3ED); /* Blue gradient */
            color: white;
            font-weight: bold;
            padding: 0.8rem 2rem;
            border-radius: 1.5rem; /* Pill shape */
            box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4);
            transition: all 0.3s ease-in-out;
            transform: scale(1);
        }
        .onboarding-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(66, 153, 225, 0.6);
        }
        .onboarding-button.close-btn {
            background: linear-gradient(90deg, #48BB78, #68D391); /* Green gradient for close */
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }
        .onboarding-button.close-btn:hover {
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.6);
        }


        /* Main app navigation buttons */
        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 0.75rem 0;
            color: #A0AEC0; /* Gray text */
            transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out;
            border-radius: 0.75rem;
        }
        .nav-button.active {
            color: #63B3ED; /* Light blue for active */
            background-color: rgba(99, 179, 237, 0.1); /* Light blue tint */
        }
        .nav-button:hover {
            color: #90CDF4; /* Lighter blue on hover */
        }

        /* Counter page specific styles */
        .counter-timer-circle {
            width: 220px; /* Slightly larger */
            height: 220px;
            border-radius: 50%;
            background: #1A202C; /* Darker blue */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            box-shadow: 0 0 20px rgba(99, 179, 237, 0.3);
            border: 3px solid #4A5568; /* Subtle border */
        }
        .counter-timer-circle.pulsing {
            animation: pulse-effect 1.5s infinite ease-in-out;
        }
        @keyframes pulse-effect {
            0% { box-shadow: 0 0 20px rgba(99, 179, 237, 0.3); transform: scale(1); }
            50% { box-shadow: 0 0 40px rgba(99, 179, 237, 0.6); transform: scale(1.02); }
            100% { box-shadow: 0 0 20px rgba(99, 179, 237, 0.3); transform: scale(1); }
        }
        .counter-score-display {
            font-size: 2.5rem; /* Larger score */
            font-weight: 800;
            color: #48BB78; /* Vibrant green */
            text-shadow: 0 0 10px rgba(72, 187, 120, 0.5);
            margin-top: 0.5rem;
        }

        /* Ranking modal styles */
        .ranking-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease-in-out;
        }
        .ranking-modal-content {
            background: linear-gradient(145deg, #1A202C, #2D3748);
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            animation: slide-up 0.5s ease-out;
            border: 1px solid rgba(99, 179, 237, 0.3);
        }
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: #2D3748; /* Slightly lighter gray for list items */
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .ranking-item:last-child {
            margin-bottom: 0;
        }
        .ranking-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-left: 1rem;
        }
        .top-ranker-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #ECC94B; /* Gold border for top ranker */
        }

        /* Baccalaureate page styles */
        .subject-button, .branch-button, .year-button {
            background: #2D3748;
            color: #CBD5E0;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .subject-button:hover, .branch-button:hover, .year-button:hover {
            background: #4A5568;
            transform: translateY(-2px);
        }
        .subject-button.selected, .branch-button.selected {
            background: linear-gradient(90deg, #4299E1, #63B3ED);
            color: white;
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.4);
        }
        .year-button.solved {
            background: linear-gradient(90deg, #48BB78, #68D391); /* Green for solved */
            color: white;
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.4);
        }

        .completion-frame {
            background: linear-gradient(145deg, #1A202C, #2D3748);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(99, 179, 237, 0.3);
        }
        .progress-bar-container {
            width: 100%;
            background-color: #4A5568;
            border-radius: 0.5rem;
            overflow: hidden;
            height: 20px;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #63B3ED, #4299E1);
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    <div id="splash-screen">
        <div class="splash-spinner"></div>
        <div class="splash-text">4YOU BAC</div>
    </div>

    <div class="background-animation"></div>

    <div id="onboarding-overlay" class="onboarding-overlay" style="display:none;">
        <div id="onboarding-card" class="onboarding-card">
            <h2 id="onboarding-title" class="onboarding-title"></h2>
            <p id="onboarding-text" class="onboarding-text"></p>
            <div class="flex justify-between mt-4">
                <button id="onboarding-prev" class="onboarding-button" style="display:none;">
                    السابق
                </button>
                <button id="onboarding-next" class="onboarding-button">
                    التالي
                </button>
                <button id="onboarding-close" class="onboarding-button close-btn" style="display:none;">
                    إغلاق
                </button>
            </div>
        </div>
    </div>

    <div id="main-app" class="flex flex-col flex-grow w-full h-full" style="display:none;">
        <header class="p-4 text-center text-3xl font-bold text-blue-400">
            4YOU BAC
        </header>

        <main class="flex-grow p-4 overflow-y-auto flex justify-center items-start">
            <div id="home-page" class="page flex flex-col items-center justify-start h-full w-full max-w-xl">
                <div class="flex flex-col items-center mb-8 bg-gray-800 p-6 rounded-2xl shadow-xl w-full">
                    <img id="user-profile-pic" src="https://placehold.co/100x100/0A192F/E2E8F0?text=صورة" alt="صورة المستخدم" class="w-28 h-28 rounded-full border-4 border-blue-500 mb-4 object-cover">
                    <div class="text-center">
                        <h1 id="user-name" class="text-3xl font-bold text-blue-300 mb-1">اسم المستخدم</h1>
                        <p class="text-gray-400 text-lg">مرحباً بك في 4YOU BAC!</p>
                        <p class="text-gray-500 text-sm mt-1">معرف المستخدم: <span id="user-id-display">...</span></p>
                    </div>
                </div>

                <div class="bg-gray-800 p-8 rounded-2xl shadow-xl text-center mb-8 w-full">
                    <h2 class="text-xl font-semibold text-gray-300 mb-2">السكور الخاص بك</h2>
                    <p id="user-score" class="text-7xl font-extrabold text-green-400 mb-4 animate-bounce">0</p>
                </div>

                <div class="flex flex-col md:flex-row justify-around w-full max-w-2xl">
                    <div id="general-ranking-card" class="bg-gray-800 p-6 rounded-2xl shadow-xl text-center mb-4 md:mb-0 md:w-1/2 mx-2 cursor-pointer transform transition duration-300 hover:scale-105 hover:bg-gray-700">
                        <h2 class="text-xl font-semibold text-gray-300 mb-2">التصنيف العام</h2>
                        <p id="general-rank" class="text-4xl font-bold text-yellow-400">#N/A</p>
                    </div>
                    <div id="weekly-ranking-card" class="bg-gray-800 p-6 rounded-2xl shadow-xl text-center md:w-1/2 mx-2 cursor-pointer transform transition duration-300 hover:scale-105 hover:bg-gray-700">
                        <h2 class="text-xl font-semibold text-gray-300 mb-2">التصنيف الأسبوعي</h2>
                        <p id="weekly-rank" class="text-4xl font-bold text-purple-400">#N/A</p>
                    </div>
                </div>
            </div>

            <div id="counter-page" class="page flex flex-col items-center justify-start h-full hidden">
                <div class="relative w-full max-w-md mb-8">
                    <img src="https://placehold.co/600x300/0A192F/63B3ED?text=شخص+يدرس+بجد" alt="شخص يدرس بجد" class="w-full h-auto rounded-2xl shadow-xl object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-blue-900 via-transparent to-transparent opacity-70 rounded-2xl"></div>
                </div>

                <div id="counter-timer-container" class="counter-timer-circle mb-8">
                    <p id="counter-time" class="text-5xl font-extrabold text-blue-300 mb-2">00:00:00</p>
                    <p id="counter-score" class="counter-score-display">0</p>
                </div>

                <button id="start-stop-button" class="bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-75">
                    البداية
                </button>
            </div>

            <div id="baccalaureate-page" class="page flex flex-col items-center justify-start h-full hidden w-full max-w-2xl">
                <h2 class="text-4xl font-bold text-blue-300 mb-8">بكالوريات</h2>

                <div id="bac-subject-selection" class="w-full">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                        </div>
                    <button id="bac-continue-subjects" class="w-full bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition duration-300 transform hover:scale-105">
                        المتابعة
                    </button>
                </div>

                <div id="bac-details-selection" class="w-full hidden">
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-xl mb-6 w-full">
                        <h3 class="text-xl font-semibold text-gray-300 mb-4">المواد المختارة:</h3>
                        <div id="selected-subjects-display" class="flex flex-wrap gap-2 mb-4">
                            </div>
                        <button id="bac-edit-subjects" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105">
                            تعديل المواد
                        </button>
                    </div>

                    <div class="completion-frame w-full mb-6">
                        <h3 class="text-xl font-semibold text-gray-300 mb-4 text-center">نسبة إكمال المواضيع الكلية</h3>
                        <div class="progress-bar-container">
                            <div id="overall-completion-bar" class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p id="overall-completion-text" class="text-center text-blue-300 font-bold mt-2">0% مكتمل</p>
                    </div>

                    <div id="bac-material-details" class="w-full">
                        </div>
                </div>
            </div>
        </main>

        <footer class="w-full bg-gray-900 border-t border-gray-700 flex justify-around p-2 shadow-inner">
            <button id="nav-home" class="nav-button active">
                <svg class="w-7 h-7 mb-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path>
                </svg>
                <span class="text-xs">الرئيسية</span>
            </button>
            <button id="nav-counter" class="nav-button">
                <svg class="w-7 h-7 mb-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 4.5C7.5 4.5 4 8 4 12.5S7.5 20.5 12 20.5 20 17 20 12.5 16.5 4.5 12 4.5zm0 14c-3.03 0-5.5-2.47-5.5-5.5s2.47-5.5 5.5-5.5 5.5 2.47 5.5 5.5-2.47 5.5-5.5 5.5zM11 9h2v4h-2zm0 5h2v2h-2z"></path>
                </svg>
                <span class="text-xs">العداد</span>
            </button>
            <button id="nav-baccalaureate" class="nav-button">
                <svg class="w-7 h-7 mb-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path>
                </svg>
                <span class="text-xs">بكالوريات</span>
            </button>
        </footer>
    </div>

    <div id="ranking-modal" class="ranking-modal" style="display:none;">
        <div class="ranking-modal-content">
            <h2 id="ranking-modal-title" class="text-3xl font-bold text-blue-300 mb-6 text-center"></h2>
            <div id="top-rankers" class="flex justify-center items-end mb-8">
                </div>
            <div id="other-rankings" class="flex flex-col gap-3 mb-6">
                </div>
            <div id="user-own-rank" class="bg-blue-900 p-4 rounded-xl shadow-inner text-center text-lg font-semibold text-blue-200" style="display:none;">
                </div>
            <button id="ranking-modal-close" class="mt-8 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 transform hover:scale-105">
                إغلاق
            </button>
        </div>
    </div>

    <script type="module">
        // Check if the Telegram Web App object is available
        const isTelegramWebApp = typeof window.Telegram !== 'undefined' && window.Telegram.WebApp;

        // --- Global Elements ---
        const splashScreen = document.getElementById('splash-screen');
        const onboardingOverlay = document.getElementById('onboarding-overlay');
        const mainApp = document.getElementById('main-app');

        // --- Splash Screen Logic ---
        function showSplashScreen() {
            splashScreen.style.display = 'flex';
            setTimeout(() => {
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    window.initializeFirebase(); // Initialize Firebase after splash fades
                    // checkOnboardingStatus() will be called after Firebase data loads
                }, 1000); // Wait for fade out
            }, 2000); // Display splash for 2 seconds
        }

        // --- Onboarding Logic ---
        const onboardingCard = document.getElementById('onboarding-card');
        const onboardingTitle = document.getElementById('onboarding-title');
        const onboardingText = document.getElementById('onboarding-text');
        const onboardingPrevBtn = document.getElementById('onboarding-prev');
        const onboardingNextBtn = document.getElementById('onboarding-next');
        const onboardingCloseBtn = document.getElementById('onboarding-close');

        const onboardingContent = [
            {
                title: "حساب ترتيبك وتحفيزك",
                text: "سيتم حساب ترتيبك بناءً على أدائك، مما يحفزك للتقدم أكثر وتحقيق أفضل النتائج!"
            },
            {
                title: "ميزات جديدة قريبًا",
                text: "نعمل باستمرار على إضافة ميزات جديدة ومثيرة لتجربة أفضل. ترقبوا التحديثات القادمة!"
            },
            {
                title: "الشفافية وتحذير من الغش",
                text: "تطبيقنا يركز على الشفافية والعدالة. لا توجد طرق للغش، والجميع يتنافس بشرف."
            },
            {
                title: "مجموعة 4YOU BAC",
                text: "هذا التطبيق هو جزء من عائلة '4YOU BAC' من عمل 'Askeladd'. نتمنى لكم تجربة موفقة!"
            }
        ];
        let currentOnboardingStep = 0;

        function showOnboardingStep(step) {
            onboardingTitle.textContent = onboardingContent[step].title;
            onboardingText.textContent = onboardingContent[step].text;

            onboardingPrevBtn.style.display = (step > 0) ? 'inline-block' : 'none';
            onboardingNextBtn.style.display = (step < onboardingContent.length - 1) ? 'inline-block' : 'none';
            onboardingCloseBtn.style.display = (step === onboardingContent.length - 1) ? 'inline-block' : 'none';
        }

        function closeOnboarding() {
            onboardingOverlay.style.opacity = '0';
            setTimeout(() => {
                onboardingOverlay.style.display = 'none';
                mainApp.style.display = 'flex';
                localStorage.setItem('seenOnboarding', 'true'); // Update local storage
                window.saveUserData(); // Save to Firestore
            }, 300);
        }

        onboardingPrevBtn.addEventListener('click', () => {
            if (currentOnboardingStep > 0) {
                currentOnboardingStep--;
                showOnboardingStep(currentOnboardingStep);
            }
        });

        onboardingNextBtn.addEventListener('click', () => {
            if (currentOnboardingStep < onboardingContent.length - 1) {
                currentOnboardingStep++;
                showOnboardingStep(currentOnboardingStep);
            }
        });

        onboardingCloseBtn.addEventListener('click', closeOnboarding);

        function checkOnboardingStatus() {
            // This function is called after user data is loaded from Firestore (or local fallback)
            // It decides whether to show the onboarding or the main app.
            if (localStorage.getItem('seenOnboarding') === 'true') {
                onboardingOverlay.style.display = 'none'; // Ensure onboarding is hidden
                mainApp.style.display = 'flex'; // Show main app
                console.log("Onboarding already seen, showing main app.");
            } else {
                onboardingOverlay.style.display = 'flex'; // Show onboarding
                mainApp.style.display = 'none'; // Ensure main app is hidden
                showOnboardingStep(currentOnboardingStep);
                console.log("Showing onboarding for the first time.");
            }
        }

        // --- Initial Load ---
        window.onload = () => {
            showSplashScreen(); // Start with the splash screen

            // Initialize Telegram Web App if available
            if (isTelegramWebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.setBackgroundColor('#0A192F');
                window.Telegram.WebApp.expand();

                const userData = window.Telegram.WebApp.initDataUnsafe.user;
                if (userData) {
                    document.getElementById('user-name').textContent = userData.first_name + (userData.last_name ? ' ' + userData.last_name : '');
                    document.getElementById('user-profile-pic').src = `https://placehold.co/100x100/0A192F/E2E8F0?text=${userData.first_name.charAt(0)}`;
                    document.getElementById('user-id-display').textContent = userData.id;
                }
            } else {
                document.getElementById('user-name').textContent = 'زائر';
                document.getElementById('user-profile-pic').src = 'https://placehold.co/100x100/0A192F/E2E8F0?text=زائر';
                document.getElementById('user-id-display').textContent = 'غير متوفر';
            }
        };


        // --- Navigation Logic ---
        const homePage = document.getElementById('home-page');
        const counterPage = document.getElementById('counter-page');
        const baccalaureatePage = document.getElementById('baccalaureate-page');

        const navHomeBtn = document.getElementById('nav-home');
        const navCounterBtn = document.getElementById('nav-counter');
        const navBaccalaureateBtn = document.getElementById('nav-baccalaureate');

        const pages = [homePage, counterPage, baccalaureatePage];
        const navButtons = [navHomeBtn, navCounterBtn, navBaccalaureateBtn];

        function showPage(pageToShow) {
            pages.forEach(page => {
                page.style.display = 'none';
            });
            navButtons.forEach(button => {
                button.classList.remove('active');
            });

            pageToShow.style.display = 'flex';
            const activeButton = navButtons[pages.indexOf(pageToShow)];
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        navHomeBtn.addEventListener('click', () => showPage(homePage));
        navCounterBtn.addEventListener('click', () => showPage(counterPage));
        navBaccalaureateBtn.addEventListener('click', () => showPage(baccalaureatePage));

        // --- Home Page Data (Dummy Data for Rankings) ---
        const userScoreElement = document.getElementById('user-score');

        // Dummy user score and ranks (userCurrentScore will be updated from Firestore)
        let userCurrentScore = 0; // Initialized to 0, will be loaded from Firestore
        let userGeneralRank = 15; // These are still dummy for now
        let userWeeklyRank = 7; // These are still dummy for now

        const generalRankElement = document.getElementById('general-rank');
        const weeklyRankElement = document.getElementById('weekly-rank');

        generalRankElement.textContent = `#${userGeneralRank}`;
        weeklyRankElement.textContent = `#${userWeeklyRank}`;


        // Dummy ranking data
        const dummyGeneralRankings = [
            { id: 1, name: 'أحمد سعيد', score: 2500, img: 'https://placehold.co/50x50/3182CE/FFFFFF?text=AS' },
            { id: 2, name: 'فاطمة محمد', score: 2300, img: 'https://placehold.co/50x50/F6AD55/FFFFFF?text=FM' },
            { id: 3, name: 'علياء خالد', score: 2100, img: 'https://placehold.co/50x50/48BB78/FFFFFF?text=AK' },
            { id: 4, name: 'يوسف ناصر', score: 1900, img: 'https://placehold.co/50x50/9F7AEA/FFFFFF?text=YN' },
            { id: 5, name: 'مريم حسين', score: 1850, img: 'https://placehold.co/50x50/ED8936/FFFFFF?text=MH' },
            { id: 6, name: 'خالد فهد', score: 1700, img: 'https://placehold.co/50x50/667EEA/FFFFFF?text=KF' },
            { id: 7, name: 'سارة عبد الله', score: 1650, img: 'https://placehold.co/50x50/4299E1/FFFFFF?text=SA' },
            { id: 8, name: 'نور الدين', score: 1600, img: 'https://placehold.co/50x50/A0AEC0/FFFFFF?text=ND' },
            { id: 9, name: 'ليلى جمال', score: 1550, img: 'https://placehold.co/50x50/F6E05E/FFFFFF?text=LG' },
            { id: 10, name: 'عمران قاسم', score: 1500, img: 'https://placehold.co/50x50/E53E3E/FFFFFF?text=OQ' },
            { id: 11, name: 'زينب عادل', score: 1400, img: 'https://placehold.co/50x50/38B2AC/FFFFFF?text=ZA' },
            { id: 12, name: 'فارس محمود', score: 1350, img: 'https://placehold.co/50x50/805AD5/FFFFFF?text=FM' },
            { id: 13, name: 'جنى كرم', score: 1300, img: 'https://placehold.co/50x50/D53F8C/FFFFFF?text=JK' },
            { id: 14, name: 'أنس وليد', score: 1280, img: 'https://placehold.co/50x50/2D3748/FFFFFF?text=AW' },
            { id: 15, name: 'أنت', score: userCurrentScore, img: document.getElementById('user-profile-pic').src, isUser: true } // User's own entry
        ].sort((a, b) => b.score - a.score); // Sort by score descending

        const dummyWeeklyRankings = [
            { id: 1, name: 'أحمد سعيد', score: 500, img: 'https://placehold.co/50x50/3182CE/FFFFFF?text=AS' },
            { id: 2, name: 'علياء خالد', score: 450, img: 'https://placehold.co/50x50/48BB78/FFFFFF?text=AK' },
            { id: 3, name: 'فاطمة محمد', score: 400, img: 'https://placehold.co/50x50/F6AD55/FFFFFF?text=FM' },
            { id: 4, name: 'مريم حسين', score: 380, img: 'https://placehold.co/50x50/ED8936/FFFFFF?text=MH' },
            { id: 5, name: 'يوسف ناصر', score: 350, img: 'https://placehold.co/50x50/9F7AEA/FFFFFF?text=YN' },
            { id: 6, name: 'سارة عبد الله', score: 320, img: 'https://placehold.co/50x50/4299E1/FFFFFF?text=SA' },
            { id: 7, name: 'أنت', score: userCurrentScore / 5, img: document.getElementById('user-profile-pic').src, isUser: true }, // User's own entry for weekly
            { id: 8, name: 'خالد فهد', score: 300, img: 'https://placehold.co/50x50/667EEA/FFFFFF?text=KF' },
            { id: 9, name: 'نور الدين', score: 280, img: 'https://placehold.co/50x50/A0AEC0/FFFFFF?text=ND' },
            { id: 10, name: 'ليلى جمال', score: 250, img: 'https://placehold.co/50x50/F6E05E/FFFFFF?text=LG' }
        ].sort((a, b) => b.score - a.score); // Sort by score descending


        // --- Ranking Modal Logic ---
        const rankingModal = document.getElementById('ranking-modal');
        const rankingModalTitle = document.getElementById('ranking-modal-title');
        const topRankersContainer = document.getElementById('top-rankers');
        const otherRankingsContainer = document.getElementById('other-rankings');
        const userOwnRankContainer = document.getElementById('user-own-rank');
        const rankingModalCloseBtn = document.getElementById('ranking-modal-close');

        function showRankingModal(type) {
            let rankingsData;
            let title;
            let userRankValue;

            if (type === 'general') {
                rankingsData = dummyGeneralRankings;
                title = "التصنيف العام";
                userRankValue = userGeneralRank;
            } else { // weekly
                rankingsData = dummyWeeklyRankings;
                title = "التصنيف الأسبوعي";
                userRankValue = userWeeklyRank;
            }

            rankingModalTitle.textContent = title;
            topRankersContainer.innerHTML = '';
            otherRankingsContainer.innerHTML = '';
            userOwnRankContainer.style.display = 'none';

            // Display Top 3
            rankingsData.slice(0, 3).forEach((ranker, index) => {
                const rankerDiv = document.createElement('div');
                rankerDiv.className = `flex flex-col items-center mx-2 ${index === 0 ? 'order-2' : (index === 1 ? 'order-1' : 'order-3')}`; // Order for 2-1-3 layout
                rankerDiv.innerHTML = `
                    <img src="${ranker.img}" alt="${ranker.name}" class="top-ranker-img ${index === 0 ? 'w-24 h-24 border-yellow-400' : 'w-20 h-20 border-gray-500'} mb-2 transform transition duration-300 hover:scale-110">
                    <p class="text-xl font-bold text-gray-200">${ranker.name}</p>
                    <p class="text-md text-gray-400">السكور: ${ranker.score}</p>
                    <p class="text-3xl font-extrabold ${index === 0 ? 'text-yellow-300' : (index === 1 ? 'text-gray-400' : 'text-amber-600')}">#${index + 1}</p>
                `;
                topRankersContainer.appendChild(rankerDiv);
            });

            // Display other rankings up to 10
            rankingsData.slice(3, 10).forEach((ranker, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = 'ranking-item';
                rankItem.innerHTML = `
                    <span class="font-bold text-lg text-blue-300 w-8 text-center">#${index + 4}</span>
                    <img src="${ranker.img}" alt="${ranker.name}" class="w-10 h-10 rounded-full object-cover ml-4">
                    <span class="flex-grow text-gray-200">${ranker.name}</span>
                    <span class="text-gray-400">السكور: ${ranker.score}</span>
                `;
                otherRankingsContainer.appendChild(rankItem);
            });

            // Display user's own rank if outside top 10
            if (userRankValue > 10) {
                userOwnRankContainer.style.display = 'block';
                userOwnRankContainer.innerHTML = `
                    <p>ترتيبك: <span class="text-blue-300 font-bold">#${userRankValue}</span></p>
                    <p>السكور الخاص بك: <span class="text-green-300 font-bold">${userCurrentScore}</span></p>
                `;
            }

            rankingModal.style.display = 'flex';
            setTimeout(() => rankingModal.style.opacity = '1', 10); // Fade in
        }

        function closeRankingModal() {
            rankingModal.style.opacity = '0';
            setTimeout(() => rankingModal.style.display = 'none', 300); // Fade out
        }

        document.getElementById('general-ranking-card').addEventListener('click', () => showRankingModal('general'));
        document.getElementById('weekly-ranking-card').addEventListener('click', () => showRankingModal('weekly'));
        rankingModalCloseBtn.addEventListener('click', closeRankingModal);


        // --- Counter Page Timer Logic ---
        const counterTimeElement = document.getElementById('counter-time');
        const counterScoreElement = document.getElementById('counter-score');
        const startStopButton = document.getElementById('start-stop-button');
        const counterTimerCircle = document.getElementById('counter-timer-container');

        let timerInterval;
        let isRunning = false;
        let seconds = 0;
        let counterScore = 0;

        function formatTime(totalSeconds) {
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const s = String(totalSeconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function updateTimer() {
            seconds++;
            counterTimeElement.textContent = formatTime(seconds);
            // Example scoring: 1 point every 10 seconds
            if (seconds % 10 === 0) {
                counterScore += 1;
                counterScoreElement.textContent = counterScore; // No prefix
            }
        }

        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                startStopButton.textContent = 'إيقاف';
                startStopButton.classList.remove('from-blue-500', 'to-blue-700');
                startStopButton.classList.add('from-red-500', 'to-red-700');
                counterTimerCircle.classList.add('pulsing');
                timerInterval = setInterval(updateTimer, 1000);
            }
        }

        function stopTimer() {
            if (isRunning) {
                isRunning = false;
                startStopButton.textContent = 'البداية';
                startStopButton.classList.remove('from-red-500', 'to-red-700');
                startStopButton.classList.add('from-blue-500', 'to-blue-700');
                counterTimerCircle.classList.remove('pulsing');
                clearInterval(timerInterval);
                // Update userCurrentScore and save to Firestore
                userCurrentScore += counterScore;
                userScoreElement.textContent = userCurrentScore;
                window.saveUserData(); // Save updated score to Firestore

                counterScore = 0; // Reset for next session
                counterScoreElement.textContent = counterScore;
            }
        }

        startStopButton.addEventListener('click', () => {
            if (isRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        });

        // Intelligent timer: Pause when app is in background
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (isRunning) {
                    stopTimer();
                }
            }
        });

        // --- Baccalaureate Page Logic ---
        const bacSubjectSelection = document.getElementById('bac-subject-selection');
        const bacDetailsSelection = document.getElementById('bac-details-selection');
        const selectedSubjectsDisplay = document.getElementById('selected-subjects-display');
        const bacMaterialDetails = document.getElementById('bac-material-details');
        const overallCompletionBar = document.getElementById('overall-completion-bar');
        const overallCompletionText = document.getElementById('overall-completion-text');

        const subjects = [
            { name: 'رياضيات', id: 'math', branches: ['جميع الشعب'] },
            { name: 'فيزياء', id: 'physics', branches: ['جميع الشعب'] },
            { name: 'اللغة العربية', id: 'arabic', branches: ['جميع الشعب'] },
            { name: 'فرنسية', id: 'french', branches: ['جميع الشعب'] },
            { name: 'انجليزية', id: 'english', branches: ['جميع الشعب'] },
            { name: 'الاجتماعيات', id: 'social', branches: ['جميع الشعب'] },
            { name: 'الشريعة', id: 'islamic', branches: ['جميع الشعب'] },
            { name: 'العلوم طبيعية و حياة', id: 'science', branches: ['شعبة رياضيات', 'شعبة علوم تجريبية'] }
        ];

        const bacYears = Array.from({ length: 2025 - 2008 + 1 }, (_, i) => 2008 + i); // Years from 2008 to 2025

        // Initialized from Firestore in loadBaccalaureateState
        let selectedBacSubjects = [];
        let solvedBacYears = {}; // structure: { 'subjectId': { 'branchName': { 'year': true/false, 'selectedBranch': 'branchName' } } }

        function renderSubjectSelection() {
            const subjectGrid = bacSubjectSelection.querySelector('.grid');
            subjectGrid.innerHTML = '';
            subjects.forEach(subject => {
                const button = document.createElement('button');
                button.className = `subject-button ${selectedBacSubjects.includes(subject.id) ? 'selected' : ''}`;
                button.textContent = subject.name;
                button.dataset.subjectId = subject.id;
                button.addEventListener('click', () => {
                    if (selectedBacSubjects.includes(subject.id)) {
                        selectedBacSubjects = selectedBacSubjects.filter(id => id !== subject.id);
                        // Also remove from solvedBacYears if subject is deselected
                        delete solvedBacYears[subject.id];
                    } else {
                        selectedBacSubjects.push(subject.id);
                        // Initialize solvedYears for this subject if not exists
                        if (!solvedBacYears[subject.id]) {
                            solvedBacYears[subject.id] = {};
                            if (subject.branches.length > 0) {
                                solvedBacYears[subject.id].selectedBranch = subject.branches[0]; // Auto-select first branch
                            }
                        }
                    }
                    window.saveBaccalaureateState(); // Save state after selection change
                    renderSubjectSelection(); // Re-render to update selection state
                });
                subjectGrid.appendChild(button);
            });
        }

        function renderBacDetails() {
            selectedSubjectsDisplay.innerHTML = '';
            bacMaterialDetails.innerHTML = '';

            if (selectedBacSubjects.length === 0) {
                selectedSubjectsDisplay.innerHTML = '<p class="text-gray-400">لم يتم اختيار أي مواد بعد.</p>';
            } else {
                selectedBacSubjects.forEach(subjectId => {
                    const subject = subjects.find(s => s.id === subjectId);
                    if (subject) {
                        const span = document.createElement('span');
                        span.className = 'bg-blue-700 text-white text-sm px-3 py-1 rounded-full';
                        span.textContent = subject.name;
                        selectedSubjectsDisplay.appendChild(span);

                        // Render branches and years for each selected subject
                        const subjectDetailDiv = document.createElement('div');
                        subjectDetailDiv.className = 'bg-gray-800 p-6 rounded-2xl shadow-xl mb-6';
                        subjectDetailDiv.innerHTML = `
                            <h3 class="text-xl font-semibold text-blue-300 mb-4">${subject.name}</h3>
                            <div class="flex flex-wrap gap-3 mb-4" id="branches-${subject.id}">
                                </div>
                            <div id="years-${subject.id}" class="grid grid-cols-4 md:grid-cols-6 gap-3">
                                </div>
                        `;
                        bacMaterialDetails.appendChild(subjectDetailDiv);

                        const branchContainer = document.getElementById(`branches-${subject.id}`);
                        const yearsContainer = document.getElementById(`years-${subject.id}`);

                        // Ensure solvedYears structure for this subject exists
                        if (!solvedBacYears[subject.id]) {
                            solvedBacYears[subject.id] = {};
                        }

                        subject.branches.forEach(branchName => {
                            const branchButton = document.createElement('button');
                            branchButton.className = `branch-button ${solvedBacYears[subject.id].selectedBranch === branchName ? 'selected' : ''}`;
                            branchButton.textContent = branchName;
                            branchButton.dataset.branchName = branchName;
                            branchButton.addEventListener('click', () => {
                                solvedBacYears[subject.id].selectedBranch = branchName;
                                window.saveBaccalaureateState();
                                renderBacDetails(); // Re-render to update selected branch and years
                            });
                            branchContainer.appendChild(branchButton);

                            // Render years only for the selected branch
                            if (solvedBacYears[subject.id].selectedBranch === branchName) {
                                yearsContainer.innerHTML = ''; // Clear previous years
                                if (!solvedBacYears[subject.id][branchName]) {
                                    solvedBacYears[subject.id][branchName] = {};
                                }
                                bacYears.forEach(year => {
                                    const yearButton = document.createElement('button');
                                    yearButton.className = `year-button ${solvedBacYears[subject.id][branchName][year] ? 'solved' : ''}`;
                                    yearButton.textContent = year;
                                    yearButton.dataset.year = year;
                                    yearButton.addEventListener('click', () => {
                                        solvedBacYears[subject.id][branchName][year] = !solvedBacYears[subject.id][branchName][year];
                                        window.saveBaccalaureateState(); // Save state after solving/unsolving
                                        renderBacDetails(); // Re-render to update solved state and completion
                                    });
                                    yearsContainer.appendChild(yearButton);
                                });
                            }
                        });
                        // Auto-select first branch if none selected for this subject
                        if (!solvedBacYears[subject.id].selectedBranch && subject.branches.length > 0) {
                            solvedBacYears[subject.id].selectedBranch = subject.branches[0];
                            window.saveBaccalaureateState();
                            renderBacDetails(); // Re-render to show years for auto-selected branch
                        }
                    }
                });
            }
            calculateOverallCompletion();
            // No need to save here, as individual button clicks already call saveBaccalaureateState()
        }


        function calculateOverallCompletion() {
            let totalPossibleYears = 0;
            let solvedYearsCount = 0;

            selectedBacSubjects.forEach(subjectId => {
                const subject = subjects.find(s => s.id === subjectId);
                if (subject) {
                    subject.branches.forEach(branchName => {
                        // All years for each branch of selected subjects contribute to total possible
                        totalPossibleYears += bacYears.length;
                        if (solvedBacYears[subject.id] && solvedBacYears[subject.id][branchName]) {
                            Object.values(solvedBacYears[subject.id][branchName]).forEach(isSolved => {
                                if (isSolved) {
                                    solvedYearsCount++;
                                }
                            });
                        }
                    });
                }
            });

            const completionPercentage = totalPossibleYears > 0 ? Math.round((solvedYearsCount / totalPossibleYears) * 100) : 0;
            overallCompletionBar.style.width = `${completionPercentage}%`;
            overallCompletionText.textContent = `${completionPercentage}% مكتمل`;
        }


        document.getElementById('bac-continue-subjects').addEventListener('click', () => {
            bacSubjectSelection.style.display = 'none';
            bacDetailsSelection.style.display = 'block';
            renderBacDetails();
        });

        document.getElementById('bac-edit-subjects').addEventListener('click', () => {
            bacSubjectSelection.style.display = 'block';
            bacDetailsSelection.style.display = 'none';
            renderSubjectSelection();
        });

        // Prevent horizontal scrolling on mobile devices
        document.documentElement.style.overflowX = 'hidden';
        document.body.style.overflowX = 'hidden';

    </script>
</body>
</html>

